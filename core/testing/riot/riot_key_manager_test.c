// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT license.

#include <stddef.h>
#include <stdint.h>
#include <string.h>
#include "platform_api.h"
#include "testing.h"
#include "common/array_size.h"
#include "riot/riot_key_manager.h"
#include "riot/riot_key_manager_static.h"
#include "testing/asn1/x509_testing.h"
#include "testing/engines/ecc_testing_engine.h"
#include "testing/engines/x509_testing_engine.h"
#include "testing/mock/asn1/x509_mock.h"
#include "testing/mock/keystore/keystore_mock.h"
#include "testing/riot/riot_core_testing.h"


TEST_SUITE_LABEL ("riot_key_manager");


/**
 * Dependencies for testing the DICE identity key manager.
 */
struct riot_key_manager_testing {
	X509_TESTING_ENGINE (x509);				/**< X.509 engine for verifying certificates. */
	struct x509_engine_mock x509_mock;		/**<  Mock for X.509 verification. */
	struct keystore_mock keystore;			/**< Mock for the keystore used to store certs. */
	struct riot_keys keys;					/**< DICE keys to manage. */
	struct riot_key_manager_state state;	/**< Variable context for the DICE key manager. */
	struct riot_key_manager test;			/**< DICE key manager under test. */
};


/**
 * Helper to initialize all dependencies for testing.
 *
 * @param test The test framework.
 * @param manager Testing dependencies to initialize.
 */
static void riot_key_manager_testing_init_dependencies (CuTest *test,
	struct riot_key_manager_testing *manager)
{
	int status;

	status = X509_TESTING_ENGINE_INIT (&manager->x509);
	CuAssertIntEquals (test, 0, status);

	status = x509_mock_init (&manager->x509_mock);
	CuAssertIntEquals (test, 0, status);

	status = keystore_mock_init (&manager->keystore);
	CuAssertIntEquals (test, 0, status);
}

/**
 * Helper to validate mocks and release all testing dependencies.
 *
 * @param test The test framework.
 * @param manager Testing dependencies to release.
 */
static void riot_key_manager_testing_release_dependencies (CuTest *test,
	struct riot_key_manager_testing *manager)
{
	int status;

	status = x509_mock_validate_and_release (&manager->x509_mock);
	status |= keystore_mock_validate_and_release (&manager->keystore);

	CuAssertIntEquals (test, 0, status);

	X509_TESTING_ENGINE_RELEASE (&manager->x509);
}

/**
 * Initialize the DICE identity key structure that would be generated by DICE layer 0.
 *
 * @param test The testing framework.
 * @param keys The keys to initialize.
 */
static void riot_key_manager_testing_alloc_riot_core_keys (CuTest *test, struct riot_keys *keys)
{
	keys->devid_csr = platform_malloc (RIOT_CORE_DEVID_CSR_LEN);
	CuAssertPtrNotNull (test, keys->devid_csr);

	memcpy ((uint8_t*) keys->devid_csr, RIOT_CORE_DEVID_CSR, RIOT_CORE_DEVID_CSR_LEN);
	keys->devid_csr_length = RIOT_CORE_DEVID_CSR_LEN;

	keys->devid_cert = platform_malloc (RIOT_CORE_DEVID_CERT_LEN);
	CuAssertPtrNotNull (test, keys->devid_cert);

	memcpy ((uint8_t*) keys->devid_cert, RIOT_CORE_DEVID_CERT, RIOT_CORE_DEVID_CERT_LEN);
	keys->devid_cert_length = RIOT_CORE_DEVID_CERT_LEN;

	keys->alias_key = platform_malloc (RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertPtrNotNull (test, keys->alias_key);

	memcpy ((uint8_t*) keys->alias_key, RIOT_CORE_ALIAS_KEY, RIOT_CORE_ALIAS_KEY_LEN);
	keys->alias_key_length = RIOT_CORE_ALIAS_KEY_LEN;

	keys->alias_cert = platform_malloc (RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertPtrNotNull (test, keys->alias_cert);

	memcpy ((uint8_t*) keys->alias_cert, RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN);
	keys->alias_cert_length = RIOT_CORE_ALIAS_CERT_LEN;
}

/**
 * Free the DICE identity keys.
 *
 * @param test The testing framework.
 * @param keys The keys to free.
 */
static void riot_key_manager_testing_free_riot_core_keys (CuTest *test, struct riot_keys *keys)
{
	platform_free ((void*) keys->devid_csr);
	platform_free ((void*) keys->devid_cert);
	platform_free ((void*) keys->alias_key);
	platform_free ((void*) keys->alias_cert);
}

/**
 * Initialize the DICE identity key structure that would be generated by DICE layer 0 using static
 * buffers.
 *
 * @param test The testing framework.
 * @param keys The keys to initialize.
 */
static void riot_key_manager_testing_static_riot_core_keys (CuTest *test, struct riot_keys *keys)
{
	keys->devid_csr = RIOT_CORE_DEVID_CSR;
	keys->devid_csr_length = RIOT_CORE_DEVID_CSR_LEN;

	keys->devid_cert = RIOT_CORE_DEVID_CERT;
	keys->devid_cert_length = RIOT_CORE_DEVID_CERT_LEN;

	keys->alias_key = RIOT_CORE_ALIAS_KEY;
	keys->alias_key_length = RIOT_CORE_ALIAS_KEY_LEN;

	keys->alias_cert = RIOT_CORE_ALIAS_CERT;
	keys->alias_cert_length = RIOT_CORE_ALIAS_CERT_LEN;
}

/**
 * Initialize a DICE key manager for testing.  The manager will be initialized with no certs in the
 * keystore or extra CSRs.
 *
 * @param test The test framework.
 * @param manager Testing dependencies.
 */
static void riot_key_manager_testing_init (CuTest *test, struct riot_key_manager_testing *manager)
{
	int status;
	uint8_t *dev_id_der = NULL;

	riot_key_manager_testing_init_dependencies (test, manager);
	riot_key_manager_testing_alloc_riot_core_keys (test, &manager->keys);

	status = mock_expect (&manager->keystore.mock, manager->keystore.base.load_key,
		&manager->keystore, KEYSTORE_NO_KEY, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output_tmp (&manager->keystore.mock, 1, &dev_id_der, sizeof (dev_id_der),
		-1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager->test, &manager->state, &manager->keystore.base,
		&manager->keys, &manager->x509.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	status = mock_validate (&manager->keystore.mock);
	CuAssertIntEquals (test, 0, status);
}

/**
 * Initialize a DICE key manager for testing using the X.509 mock.  The manager will be initialized
 * with no certs in the keystore or extra CSRs.
 *
 * @param test The test framework.
 * @param manager Testing dependencies.
 */
static void riot_key_manager_testing_init_with_mock (CuTest *test,
	struct riot_key_manager_testing *manager)
{
	int status;
	uint8_t *dev_id_der = NULL;

	riot_key_manager_testing_init_dependencies (test, manager);
	riot_key_manager_testing_alloc_riot_core_keys (test, &manager->keys);

	status = mock_expect (&manager->keystore.mock, manager->keystore.base.load_key,
		&manager->keystore, KEYSTORE_NO_KEY, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output_tmp (&manager->keystore.mock, 1, &dev_id_der, sizeof (dev_id_der),
		-1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager->test, &manager->state, &manager->keystore.base,
		&manager->keys, &manager->x509_mock.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	status = mock_validate (&manager->keystore.mock);
	CuAssertIntEquals (test, 0, status);
}

/**
 * Initialize a DICE key manager for testing that contains a provisioned certificate chain.  The
 * manager will be initialized with no extra CSRs.
 *
 * @param test The test framework.
 * @param manager Testing dependencies.
 */
static void riot_key_manager_testing_init_auth_chain_stored (CuTest *test,
	struct riot_key_manager_testing *manager)
{
	int status;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der;

	riot_key_manager_testing_init_dependencies (test, manager);
	riot_key_manager_testing_alloc_riot_core_keys (test, &manager->keys);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	status = mock_expect (&manager->keystore.mock, manager->keystore.base.load_key,
		&manager->keystore, 0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output_tmp (&manager->keystore.mock, 1, &dev_id_der, sizeof (dev_id_der),
		-1);
	status |= mock_expect_output_tmp (&manager->keystore.mock, 2,
		&RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN, sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager->keystore.mock, manager->keystore.base.load_key,
		&manager->keystore, 0, MOCK_ARG (1), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output_tmp (&manager->keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output_tmp (&manager->keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager->keystore.mock, manager->keystore.base.load_key,
		&manager->keystore, 0, MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output_tmp (&manager->keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output_tmp (&manager->keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager->test, &manager->state, &manager->keystore.base,
		&manager->keys, &manager->x509.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	status = mock_validate (&manager->keystore.mock);
	CuAssertIntEquals (test, 0, status);
}

/**
 * Initialize a DICE key manager for testing that has extra CSRs to export.  The manager will be
 * initialized with no certs in the keystore.
 *
 * @param test The test framework.
 * @param manager Testing dependencies.
 * @param csrs List of extra CSRs to have available.
 * @param count Number of extra CSRs.
 */
static void riot_key_manager_testing_init_extra_csrs (CuTest *test,
	struct riot_key_manager_testing *manager, const struct der_cert *const csrs, size_t count)
{
	int status;
	uint8_t *dev_id_der = NULL;

	riot_key_manager_testing_init_dependencies (test, manager);
	riot_key_manager_testing_alloc_riot_core_keys (test, &manager->keys);

	status = mock_expect (&manager->keystore.mock, manager->keystore.base.load_key,
		&manager->keystore, KEYSTORE_NO_KEY, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output_tmp (&manager->keystore.mock, 1, &dev_id_der, sizeof (dev_id_der),
		-1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager->test, &manager->state, &manager->keystore.base,
		&manager->keys, &manager->x509.base, csrs, count);
	CuAssertIntEquals (test, 0, status);

	status = mock_validate (&manager->keystore.mock);
	CuAssertIntEquals (test, 0, status);
}

/**
 * Initialize a DICE key manager for testing that uses static keys.  The manager will be initialized
 * with no certs in the keystore.
 *
 * @param test The test framework.
 * @param manager Testing dependencies.
 * @param csrs List of extra CSRs to have available.
 * @param count Number of extra CSRs.
 */
static void riot_key_manager_testing_init_static_keys (CuTest *test,
	struct riot_key_manager_testing *manager, const struct der_cert *const csrs, size_t count)
{
	int status;
	uint8_t *dev_id_der = NULL;

	riot_key_manager_testing_init_dependencies (test, manager);
	riot_key_manager_testing_static_riot_core_keys (test, &manager->keys);

	status = mock_expect (&manager->keystore.mock, manager->keystore.base.load_key,
		&manager->keystore, KEYSTORE_NO_KEY, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output_tmp (&manager->keystore.mock, 1, &dev_id_der, sizeof (dev_id_der),
		-1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_static_keys (&manager->test, &manager->state,
		&manager->keystore.base, &manager->keys, &manager->x509.base, csrs, count);
	CuAssertIntEquals (test, 0, status);

	status = mock_validate (&manager->keystore.mock);
	CuAssertIntEquals (test, 0, status);
}

/**
 * Initialize a static DICE key manager for testing.  The manager will be initialized with no certs
 * in the keystore.
 *
 * @param test The test framework.
 * @param manager Testing dependencies.
 */
static void riot_key_manager_testing_static_init (CuTest *test,
	struct riot_key_manager_testing *manager)
{
	int status;
	uint8_t *dev_id_der = NULL;

	riot_key_manager_testing_init_dependencies (test, manager);
	riot_key_manager_testing_alloc_riot_core_keys (test, &manager->keys);

	status = mock_expect (&manager->keystore.mock, manager->keystore.base.load_key,
		&manager->keystore, KEYSTORE_NO_KEY, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output_tmp (&manager->keystore.mock, 1, &dev_id_der, sizeof (dev_id_der),
		-1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager->test, &manager->keys);
	CuAssertIntEquals (test, 0, status);

	status = mock_validate (&manager->keystore.mock);
	CuAssertIntEquals (test, 0, status);
}

/**
 * Initialize a static DICE key manager for testing that uses static keys.  The manager will be
 * initialized with no certs in the keystore.
 *
 * @param test The test framework.
 * @param manager Testing dependencies.
 */
static void riot_key_manager_testing_static_init_static_keys (CuTest *test,
	struct riot_key_manager_testing *manager)
{
	int status;
	uint8_t *dev_id_der = NULL;

	riot_key_manager_testing_init_dependencies (test, manager);
	riot_key_manager_testing_static_riot_core_keys (test, &manager->keys);

	status = mock_expect (&manager->keystore.mock, manager->keystore.base.load_key,
		&manager->keystore, KEYSTORE_NO_KEY, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output_tmp (&manager->keystore.mock, 1, &dev_id_der, sizeof (dev_id_der),
		-1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state_static_keys (&manager->test, &manager->keys);
	CuAssertIntEquals (test, 0, status);

	status = mock_validate (&manager->keystore.mock);
	CuAssertIntEquals (test, 0, status);
}

/**
 * Release DICE key manager test components and validate all mocks.
 *
 * @param test The test framework.
 * @param manager Testing components to release.
 */
static void riot_key_manager_testing_release (CuTest *test,
	struct riot_key_manager_testing *manager)
{
	riot_key_manager_release (&manager->test);
	riot_key_manager_testing_release_dependencies (test, manager);
}

/*******************
 * Test cases
 *******************/

static void riot_key_manager_test_init_no_signed_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		KEYSTORE_NO_KEY, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_bad_signed_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		KEYSTORE_BAD_KEY, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_signed_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der = NULL;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_ECC_CA_NOPL_DER, X509_CERTSS_ECC_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_ECC_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_ECC_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_intermediate_signed_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_RSA_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_RSA_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) int_ca);

	status = testing_validate_array (X509_CERTCA_ECC_CA_NOPL_DER, int_ca->cert,
		X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTCA_ECC_CA_NOPL_DER_LEN, int_ca->length);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_INTR_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_signed_device_id_no_root_ca (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der = NULL;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (1), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_signed_device_id_bad_root_ca (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der = NULL;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_BAD_KEY, MOCK_ARG (1), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_signed_device_id_not_signed_by_root (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der = NULL;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_DER, X509_CERTSS_RSA_CA_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_signed_device_id_not_sign_alias_cert (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der = NULL;

	TEST_START;

	dev_id_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_DER, X509_CERTSS_RSA_CA_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_intermediate_signed_device_id_no_ca (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der = NULL;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_intermediate_signed_device_id_bad_ca (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der = NULL;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_BAD_KEY, MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_intermediate_signed_device_id_not_trusted (CuTest *test)
{
	ECC_TESTING_ENGINE (ecc);
	X509_TESTING_ENGINE (x509_gen);
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *int_der;
	struct ecc_private_key key;
	uint8_t *key_der;
	size_t key_length;
	struct x509_certificate ca;
	uint8_t *ca_der;
	size_t ca_der_length;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	status = ECC_TESTING_ENGINE_INIT (&ecc);
	CuAssertIntEquals (test, 0, status);

	status = ecc.base.generate_key_pair (&ecc.base, ECC_KEY_LENGTH_256, &key, NULL);
	CuAssertIntEquals (test, 0, status);

	status = ecc.base.get_private_key_der (&ecc.base, &key, &key_der, &key_length);
	CuAssertIntEquals (test, 0, status);

	status = X509_TESTING_ENGINE_INIT (&x509_gen);
	CuAssertIntEquals (test, 0, status);

	status = x509_gen.base.create_self_signed_certificate (&x509_gen.base, &ca, key_der, key_length,
		HASH_TYPE_SHA256, X509_SERIAL_NUM, X509_SERIAL_NUM_LEN, "Bad", X509_CERT_CA_NO_PATHLEN,
		NULL, 0);
	CuAssertIntEquals (test, 0, status);

	status = x509_gen.base.get_certificate_der (&x509_gen.base, &ca, &ca_der, &ca_der_length);
	CuAssertIntEquals (test, 0, status);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &ca_der_length, sizeof (ca_der_length),
		-1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	platform_free (key_der);
	ecc.base.release_key_pair (&ecc.base, &key, NULL);
	manager.x509.base.release_certificate (&x509_gen.base, &ca);
	X509_TESTING_ENGINE_RELEASE (&x509_gen);
	ECC_TESTING_ENGINE_RELEASE (&ecc);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_authentication_mock (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.load_certificate,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL,
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN),
		MOCK_ARG (RIOT_CORE_ALIAS_CERT_LEN));
	mock_expect_save_arg (&manager.x509_mock.mock, 0, 0);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.init_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL);
	status |= mock_expect_save_arg (&manager.x509_mock.mock, 0, 1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_root_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTSS_RSA_CA_NOPL_DER_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_intermediate_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTCA_ECC_CA_NOPL_DER_LEN));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_intermediate_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_DEVID_INTR_SIGNED_CERT,
		RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), MOCK_ARG (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.authenticate,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (0), MOCK_ARG_SAVED_ARG (1));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_certificate,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (0));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509_mock.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_RSA_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_RSA_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) int_ca);

	status = testing_validate_array (X509_CERTCA_ECC_CA_NOPL_DER, int_ca->cert,
		X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTCA_ECC_CA_NOPL_DER_LEN, int_ca->length);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_INTR_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_extra_csr (CuTest *test)
{
	struct riot_key_manager_testing manager;
	const struct der_cert csr = {
		.cert = X509_CSR_ECC_CA_DER,
		.length = X509_CSR_ECC_CA_DER_LEN
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		KEYSTORE_NO_KEY, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509.base, &csr, 1);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_null (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;

	TEST_START;

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = riot_key_manager_init (NULL, &manager.state, &manager.keystore.base, &manager.keys,
		&manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_init (&manager.test, NULL, &manager.keystore.base, &manager.keys,
		&manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_init (&manager.test, &manager.state, NULL, &manager.keys,
		&manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base, NULL,
		&manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, NULL, NULL, 0);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	riot_key_manager_testing_free_riot_core_keys (test, &manager.keys);
	riot_key_manager_testing_release_dependencies (test, &manager);
}

static void riot_key_manager_test_init_signed_device_id_load_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		KEYSTORE_LOAD_FAILED, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509_mock.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_root_ca_load_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der = NULL;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_LOAD_FAILED, MOCK_ARG (1), MOCK_ARG_NOT_NULL,
		MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509_mock.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_intermediate_ca_load_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der = NULL;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_LOAD_FAILED, MOCK_ARG (2), MOCK_ARG_NOT_NULL,
		MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509_mock.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_authenticate_load_alias_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.load_certificate,
		&manager.x509_mock, X509_ENGINE_LOAD_FAILED, MOCK_ARG_NOT_NULL,
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN),
		MOCK_ARG (RIOT_CORE_ALIAS_CERT_LEN));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509_mock.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_authenticate_init_cert_store_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.load_certificate,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL,
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN),
		MOCK_ARG (RIOT_CORE_ALIAS_CERT_LEN));
	mock_expect_save_arg (&manager.x509_mock.mock, 0, 0);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.init_ca_cert_store,
		&manager.x509_mock,	X509_ENGINE_INIT_STORE_FAILED, MOCK_ARG_NOT_NULL);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_certificate,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (0));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509_mock.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_authenticate_add_root_ca_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.load_certificate,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL,
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN),
		MOCK_ARG (RIOT_CORE_ALIAS_CERT_LEN));
	mock_expect_save_arg (&manager.x509_mock.mock, 0, 0);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.init_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL);
	status |= mock_expect_save_arg (&manager.x509_mock.mock, 0, 1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_root_ca,
		&manager.x509_mock, X509_ENGINE_ROOT_CA_FAILED,	MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTSS_RSA_CA_NOPL_DER_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_certificate,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (0));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509_mock.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_authenticate_add_intermediate_ca_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.load_certificate,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL,
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN),
		MOCK_ARG (RIOT_CORE_ALIAS_CERT_LEN));
	mock_expect_save_arg (&manager.x509_mock.mock, 0, 0);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.init_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL);
	status |= mock_expect_save_arg (&manager.x509_mock.mock, 0, 1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_root_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTSS_RSA_CA_NOPL_DER_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_intermediate_ca,
		&manager.x509_mock,	X509_ENGINE_INTER_CA_FAILED, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTCA_ECC_CA_NOPL_DER_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_certificate,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (0));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509_mock.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_authenticate_add_device_id_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.load_certificate,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL,
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN),
		MOCK_ARG (RIOT_CORE_ALIAS_CERT_LEN));
	mock_expect_save_arg (&manager.x509_mock.mock, 0, 0);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.init_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL);
	status |= mock_expect_save_arg (&manager.x509_mock.mock, 0, 1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_root_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTSS_RSA_CA_NOPL_DER_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_intermediate_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTCA_ECC_CA_NOPL_DER_LEN));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_intermediate_ca,
		&manager.x509_mock,	X509_ENGINE_INTER_CA_FAILED, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_DEVID_INTR_SIGNED_CERT,
		RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), MOCK_ARG (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_certificate,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (0));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509_mock.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_authenticate_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.load_certificate,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL,
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN),
		MOCK_ARG (RIOT_CORE_ALIAS_CERT_LEN));
	mock_expect_save_arg (&manager.x509_mock.mock, 0, 0);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.init_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL);
	status |= mock_expect_save_arg (&manager.x509_mock.mock, 0, 1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_root_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTSS_RSA_CA_NOPL_DER_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_intermediate_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTCA_ECC_CA_NOPL_DER_LEN));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_intermediate_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_DEVID_INTR_SIGNED_CERT,
		RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), MOCK_ARG (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.authenticate,
		&manager.x509_mock, X509_ENGINE_AUTH_FAILED, MOCK_ARG_SAVED_ARG (0),
		MOCK_ARG_SAVED_ARG (1));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_certificate,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (0));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509_mock.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_static_keys_no_signed_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_static_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		KEYSTORE_NO_KEY, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_static_keys (&manager.test, &manager.state,
		&manager.keystore.base,	&manager.keys, &manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_static_keys_bad_signed_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_static_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		KEYSTORE_BAD_KEY, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_static_keys (&manager.test, &manager.state,
		&manager.keystore.base,	&manager.keys, &manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_static_keys_signed_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der = NULL;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_ECC_CA_NOPL_DER, X509_CERTSS_ECC_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_static_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_static_keys (&manager.test, &manager.state,
		&manager.keystore.base, &manager.keys, &manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_ECC_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_ECC_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_static_keys_extra_csr (CuTest *test)
{
	struct riot_key_manager_testing manager;
	const struct der_cert csr = {
		.cert = X509_CSR_ECC_CA_DER,
		.length = X509_CSR_ECC_CA_DER_LEN
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_static_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		KEYSTORE_NO_KEY, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_static_keys (&manager.test, &manager.state,
		&manager.keystore.base,	&manager.keys, &manager.x509.base, &csr, 1);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_init_static_keys_null (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;

	TEST_START;

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_static_riot_core_keys (test, &manager.keys);

	status = riot_key_manager_init_static_keys (NULL, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_init_static_keys (&manager.test, NULL, &manager.keystore.base,
		&manager.keys, &manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_init_static_keys (&manager.test, &manager.state, NULL, &manager.keys,
		&manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_init_static_keys (&manager.test, &manager.state,
		&manager.keystore.base, NULL, &manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_init_static_keys (&manager.test, &manager.state,
		&manager.keystore.base,	&manager.keys, NULL, NULL, 0);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	riot_key_manager_testing_release_dependencies (test, &manager);
}

static void riot_key_manager_test_static_init_no_signed_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		KEYSTORE_NO_KEY, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_bad_signed_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		KEYSTORE_BAD_KEY, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_signed_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der = NULL;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_ECC_CA_NOPL_DER, X509_CERTSS_ECC_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_ECC_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_ECC_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_intermediate_signed_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_RSA_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_RSA_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) int_ca);

	status = testing_validate_array (X509_CERTCA_ECC_CA_NOPL_DER, int_ca->cert,
		X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTCA_ECC_CA_NOPL_DER_LEN, int_ca->length);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_INTR_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_signed_device_id_no_root_ca (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der = NULL;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (1), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_signed_device_id_bad_root_ca (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der = NULL;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_BAD_KEY, MOCK_ARG (1), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_signed_device_id_not_signed_by_root (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der = NULL;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_DER, X509_CERTSS_RSA_CA_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_signed_device_id_not_sign_alias_cert (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der = NULL;

	TEST_START;

	dev_id_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_DER, X509_CERTSS_RSA_CA_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_intermediate_signed_device_id_no_ca (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der = NULL;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_intermediate_signed_device_id_bad_ca (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der = NULL;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_BAD_KEY, MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_intermediate_signed_device_id_not_trusted (
	CuTest *test)
{
	ECC_TESTING_ENGINE (ecc);
	X509_TESTING_ENGINE (x509_gen);
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *int_der;
	struct ecc_private_key key;
	uint8_t *key_der;
	size_t key_length;
	struct x509_certificate ca;
	uint8_t *ca_der;
	size_t ca_der_length;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	status = ECC_TESTING_ENGINE_INIT (&ecc);
	CuAssertIntEquals (test, 0, status);

	status = ecc.base.generate_key_pair (&ecc.base, ECC_KEY_LENGTH_256, &key, NULL);
	CuAssertIntEquals (test, 0, status);

	status = ecc.base.get_private_key_der (&ecc.base, &key, &key_der, &key_length);
	CuAssertIntEquals (test, 0, status);

	status = X509_TESTING_ENGINE_INIT (&x509_gen);
	CuAssertIntEquals (test, 0, status);

	status = x509_gen.base.create_self_signed_certificate (&x509_gen.base, &ca, key_der, key_length,
		HASH_TYPE_SHA256, X509_SERIAL_NUM, X509_SERIAL_NUM_LEN, "Bad", X509_CERT_CA_NO_PATHLEN,
		NULL, 0);
	CuAssertIntEquals (test, 0, status);

	status = x509_gen.base.get_certificate_der (&x509_gen.base, &ca, &ca_der, &ca_der_length);
	CuAssertIntEquals (test, 0, status);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &ca_der_length, sizeof (ca_der_length),
		-1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	platform_free (key_der);
	ecc.base.release_key_pair (&ecc.base, &key, NULL);
	manager.x509.base.release_certificate (&x509_gen.base, &ca);
	X509_TESTING_ENGINE_RELEASE (&x509_gen);
	ECC_TESTING_ENGINE_RELEASE (&ecc);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_authentication_mock (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509_mock.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.load_certificate,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL,
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN),
		MOCK_ARG (RIOT_CORE_ALIAS_CERT_LEN));
	mock_expect_save_arg (&manager.x509_mock.mock, 0, 0);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.init_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL);
	status |= mock_expect_save_arg (&manager.x509_mock.mock, 0, 1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_root_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTSS_RSA_CA_NOPL_DER_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_intermediate_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTCA_ECC_CA_NOPL_DER_LEN));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_intermediate_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_DEVID_INTR_SIGNED_CERT,
		RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), MOCK_ARG (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.authenticate,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (0), MOCK_ARG_SAVED_ARG (1));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_certificate,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (0));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_RSA_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_RSA_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) int_ca);

	status = testing_validate_array (X509_CERTCA_ECC_CA_NOPL_DER, int_ca->cert,
		X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTCA_ECC_CA_NOPL_DER_LEN, int_ca->length);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_INTR_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_extra_csr (CuTest *test)
{
	const struct der_cert csr = {
		.cert = X509_CSR_ECC_CA_DER,
		.length = X509_CSR_ECC_CA_DER_LEN
	};
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, &csr, 1)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		KEYSTORE_NO_KEY, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_null (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, NULL, 0)
	};
	struct riot_key_manager null_state = riot_key_manager_static_init (NULL, &manager.keystore.base,
		&manager.x509.base, NULL, 0);
	struct riot_key_manager null_keystore = riot_key_manager_static_init (&manager.state, NULL,
		&manager.x509.base, NULL, 0);
	struct riot_key_manager null_x509 = riot_key_manager_static_init (&manager.state,
		&manager.keystore.base, NULL, NULL, 0);
	int status;

	TEST_START;

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = riot_key_manager_init_state (NULL, &manager.keys);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_init_state (&manager.test, NULL);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_init_state (&null_state, &manager.keys);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_init_state (&null_keystore, &manager.keys);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_init_state (&null_x509, &manager.keys);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	riot_key_manager_testing_free_riot_core_keys (test, &manager.keys);
	riot_key_manager_testing_release_dependencies (test, &manager);
}

static void riot_key_manager_test_static_init_signed_device_id_load_error (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509_mock.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		KEYSTORE_LOAD_FAILED, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_root_ca_load_error (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509_mock.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der = NULL;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_LOAD_FAILED, MOCK_ARG (1), MOCK_ARG_NOT_NULL,
		MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_intermediate_ca_load_error (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509_mock.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der = NULL;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_LOAD_FAILED, MOCK_ARG (2), MOCK_ARG_NOT_NULL,
		MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_authenticate_load_alias_error (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509_mock.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.load_certificate,
		&manager.x509_mock, X509_ENGINE_LOAD_FAILED, MOCK_ARG_NOT_NULL,
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN),
		MOCK_ARG (RIOT_CORE_ALIAS_CERT_LEN));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_authenticate_init_cert_store_error (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509_mock.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.load_certificate,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL,
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN),
		MOCK_ARG (RIOT_CORE_ALIAS_CERT_LEN));
	mock_expect_save_arg (&manager.x509_mock.mock, 0, 0);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.init_ca_cert_store,
		&manager.x509_mock,	X509_ENGINE_INIT_STORE_FAILED, MOCK_ARG_NOT_NULL);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_certificate,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (0));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_authenticate_add_root_ca_error (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509_mock.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.load_certificate,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL,
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN),
		MOCK_ARG (RIOT_CORE_ALIAS_CERT_LEN));
	mock_expect_save_arg (&manager.x509_mock.mock, 0, 0);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.init_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL);
	status |= mock_expect_save_arg (&manager.x509_mock.mock, 0, 1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_root_ca,
		&manager.x509_mock, X509_ENGINE_ROOT_CA_FAILED,	MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTSS_RSA_CA_NOPL_DER_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_certificate,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (0));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_authenticate_add_intermediate_ca_error (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509_mock.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.load_certificate,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL,
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN),
		MOCK_ARG (RIOT_CORE_ALIAS_CERT_LEN));
	mock_expect_save_arg (&manager.x509_mock.mock, 0, 0);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.init_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL);
	status |= mock_expect_save_arg (&manager.x509_mock.mock, 0, 1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_root_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTSS_RSA_CA_NOPL_DER_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_intermediate_ca,
		&manager.x509_mock,	X509_ENGINE_INTER_CA_FAILED, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTCA_ECC_CA_NOPL_DER_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_certificate,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (0));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_authenticate_add_device_id_error (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509_mock.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.load_certificate,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL,
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN),
		MOCK_ARG (RIOT_CORE_ALIAS_CERT_LEN));
	mock_expect_save_arg (&manager.x509_mock.mock, 0, 0);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.init_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL);
	status |= mock_expect_save_arg (&manager.x509_mock.mock, 0, 1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_root_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTSS_RSA_CA_NOPL_DER_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_intermediate_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTCA_ECC_CA_NOPL_DER_LEN));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_intermediate_ca,
		&manager.x509_mock,	X509_ENGINE_INTER_CA_FAILED, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_DEVID_INTR_SIGNED_CERT,
		RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), MOCK_ARG (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_certificate,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (0));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_authenticate_error (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509_mock.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.load_certificate,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL,
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN),
		MOCK_ARG (RIOT_CORE_ALIAS_CERT_LEN));
	mock_expect_save_arg (&manager.x509_mock.mock, 0, 0);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.init_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL);
	status |= mock_expect_save_arg (&manager.x509_mock.mock, 0, 1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_root_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTSS_RSA_CA_NOPL_DER_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_intermediate_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTCA_ECC_CA_NOPL_DER_LEN));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_intermediate_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_DEVID_INTR_SIGNED_CERT,
		RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), MOCK_ARG (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.authenticate,
		&manager.x509_mock, X509_ENGINE_AUTH_FAILED, MOCK_ARG_SAVED_ARG (0),
		MOCK_ARG_SAVED_ARG (1));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_certificate,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (0));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_static_keys_no_signed_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_static_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		KEYSTORE_NO_KEY, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state_static_keys (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_static_keys_bad_signed_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_static_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		KEYSTORE_BAD_KEY, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state_static_keys (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_static_keys_signed_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der;
	uint8_t *ca_der;
	uint8_t *int_der = NULL;

	TEST_START;

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_ECC_CA_NOPL_DER, X509_CERTSS_ECC_CA_NOPL_DER_LEN);

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_static_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state_static_keys (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_ECC_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_ECC_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_static_keys_extra_csr (CuTest *test)
{
	const struct der_cert csr = {
		.cert = X509_CSR_ECC_CA_DER,
		.length = X509_CSR_ECC_CA_DER_LEN
	};
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, &csr, 1)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_static_riot_core_keys (test, &manager.keys);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		KEYSTORE_NO_KEY, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init_state_static_keys (&manager.test, &manager.keys);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_static_init_static_keys_null (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, NULL, 0)
	};
	struct riot_key_manager null_state = riot_key_manager_static_init (NULL, &manager.keystore.base,
		&manager.x509.base, NULL, 0);
	struct riot_key_manager null_keystore = riot_key_manager_static_init (&manager.state, NULL,
		&manager.x509.base, NULL, 0);
	struct riot_key_manager null_x509 = riot_key_manager_static_init (&manager.state,
		&manager.keystore.base, NULL, NULL, 0);
	int status;

	TEST_START;

	riot_key_manager_testing_init_dependencies (test, &manager);

	riot_key_manager_testing_static_riot_core_keys (test, &manager.keys);

	status = riot_key_manager_init_state_static_keys (NULL, &manager.keys);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_init_state_static_keys (&manager.test, NULL);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_init_state_static_keys (&null_state, &manager.keys);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_init_state_static_keys (&null_keystore, &manager.keys);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_init_state_static_keys (&null_x509, &manager.keys);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	riot_key_manager_testing_release_dependencies (test, &manager);
}

static void riot_key_manager_test_release_null (CuTest *test)
{
	TEST_START;

	riot_key_manager_release (NULL);
}

static void riot_key_manager_test_get_riot_keys_null (CuTest *test)
{
	const struct riot_keys *dev_keys;

	TEST_START;

	dev_keys = riot_key_manager_get_riot_keys (NULL);
	CuAssertPtrEquals (test, NULL, (struct riot_keys*) dev_keys);
}

static void riot_key_manager_test_get_root_ca_null (CuTest *test)
{
	const struct der_cert *root_ca;

	TEST_START;

	root_ca = riot_key_manager_get_root_ca (NULL);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);
}

static void riot_key_manager_test_get_intermediate_ca_null (CuTest *test)
{
	const struct der_cert *int_ca;

	TEST_START;

	int_ca = riot_key_manager_get_intermediate_ca (NULL);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);
}

static void riot_key_manager_test_verify_stored_certs_no_signed_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		KEYSTORE_NO_KEY, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_NO_SIGNED_DEVICE_ID, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_bad_signed_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		KEYSTORE_BAD_KEY, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_NO_SIGNED_DEVICE_ID, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_signed_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_ECC_CA_NOPL_DER, X509_CERTSS_ECC_CA_NOPL_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_ECC_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_ECC_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_intermediate_signed_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_RSA_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_RSA_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) int_ca);

	status = testing_validate_array (X509_CERTCA_ECC_CA_NOPL_DER, int_ca->cert,
		X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTCA_ECC_CA_NOPL_DER_LEN, int_ca->length);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_INTR_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_signed_device_id_no_root_ca (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (1), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_NO_ROOT_CA, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_signed_device_id_bad_root_ca (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_BAD_KEY, MOCK_ARG (1), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_NO_ROOT_CA, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_signed_device_id_not_signed_by_root (
	CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_DER, X509_CERTSS_RSA_CA_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, X509_ENGINE_CERT_NOT_VALID, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_signed_device_id_not_sign_alias_cert (
	CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	dev_id_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_DER, X509_CERTSS_RSA_CA_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, X509_ENGINE_CERT_NOT_VALID, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_intermediate_signed_device_id_no_ca (
	CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, X509_ENGINE_CERT_NOT_VALID, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_intermediate_signed_device_id_bad_ca (
	CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_BAD_KEY, MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, X509_ENGINE_CERT_NOT_VALID, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_intermediate_signed_device_id_not_trusted (
	CuTest *test)
{
	ECC_TESTING_ENGINE (ecc);
	X509_TESTING_ENGINE (x509_gen);
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *int_der = NULL;
	struct ecc_private_key key;
	uint8_t *key_der;
	size_t key_length;
	struct x509_certificate ca;
	uint8_t *ca_der;
	size_t ca_der_length;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	status = ECC_TESTING_ENGINE_INIT (&ecc);
	CuAssertIntEquals (test, 0, status);

	status = ecc.base.generate_key_pair (&ecc.base, ECC_KEY_LENGTH_256, &key, NULL);
	CuAssertIntEquals (test, 0, status);

	status = ecc.base.get_private_key_der (&ecc.base, &key, &key_der, &key_length);
	CuAssertIntEquals (test, 0, status);

	status = X509_TESTING_ENGINE_INIT (&x509_gen);
	CuAssertIntEquals (test, 0, status);

	status = x509_gen.base.create_self_signed_certificate (&x509_gen.base, &ca, key_der, key_length,
		HASH_TYPE_SHA256, X509_SERIAL_NUM, X509_SERIAL_NUM_LEN, "Bad", X509_CERT_CA_NO_PATHLEN,
		NULL, 0);
	CuAssertIntEquals (test, 0, status);

	status = x509_gen.base.get_certificate_der (&x509_gen.base, &ca, &ca_der, &ca_der_length);
	CuAssertIntEquals (test, 0, status);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, X509_ENGINE_CERT_NOT_VALID, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	platform_free (key_der);
	ecc.base.release_key_pair (&ecc.base, &key, NULL);
	manager.x509.base.release_certificate (&x509_gen.base, &ca);
	X509_TESTING_ENGINE_RELEASE (&x509_gen);
	ECC_TESTING_ENGINE_RELEASE (&ecc);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_static_keys (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_RSA_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_RSA_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) int_ca);

	status = testing_validate_array (X509_CERTCA_ECC_CA_NOPL_DER, int_ca->cert,
		X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTCA_ECC_CA_NOPL_DER_LEN, int_ca->length);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_INTR_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_static_init (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_static_init (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_RSA_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_RSA_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) int_ca);

	status = testing_validate_array (X509_CERTCA_ECC_CA_NOPL_DER, int_ca->cert,
		X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTCA_ECC_CA_NOPL_DER_LEN, int_ca->length);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_INTR_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_static_init_static_keys (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, NULL, 0)
	};
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_static_init_static_keys (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_RSA_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_RSA_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) int_ca);

	status = testing_validate_array (X509_CERTCA_ECC_CA_NOPL_DER, int_ca->cert,
		X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTCA_ECC_CA_NOPL_DER_LEN, int_ca->length);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_INTR_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_null (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	status = riot_key_manager_verify_stored_certs (NULL);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_signed_device_id_load_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		KEYSTORE_LOAD_FAILED, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, KEYSTORE_LOAD_FAILED, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_root_ca_load_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_LOAD_FAILED, MOCK_ARG (1), MOCK_ARG_NOT_NULL,
		MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, KEYSTORE_LOAD_FAILED, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_intermediate_ca_load_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_LOAD_FAILED, MOCK_ARG (2), MOCK_ARG_NOT_NULL,
		MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, KEYSTORE_LOAD_FAILED, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_load_alias_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_with_mock (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.load_certificate,
		&manager.x509_mock, X509_ENGINE_LOAD_FAILED, MOCK_ARG_NOT_NULL,
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN),
		MOCK_ARG (RIOT_CORE_ALIAS_CERT_LEN));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, X509_ENGINE_LOAD_FAILED, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_init_cert_store_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_with_mock (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.load_certificate,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL,
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN),
		MOCK_ARG (RIOT_CORE_ALIAS_CERT_LEN));
	mock_expect_save_arg (&manager.x509_mock.mock, 0, 0);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.init_ca_cert_store,
		&manager.x509_mock,	X509_ENGINE_INIT_STORE_FAILED, MOCK_ARG_NOT_NULL);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_certificate,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (0));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, X509_ENGINE_INIT_STORE_FAILED, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_add_root_ca_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_with_mock (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.load_certificate,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL,
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN),
		MOCK_ARG (RIOT_CORE_ALIAS_CERT_LEN));
	mock_expect_save_arg (&manager.x509_mock.mock, 0, 0);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.init_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL);
	status |= mock_expect_save_arg (&manager.x509_mock.mock, 0, 1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_root_ca,
		&manager.x509_mock, X509_ENGINE_ROOT_CA_FAILED,	MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTSS_RSA_CA_NOPL_DER_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_certificate,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (0));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, X509_ENGINE_ROOT_CA_FAILED, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_add_intermediate_ca_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_with_mock (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.load_certificate,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL,
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN),
		MOCK_ARG (RIOT_CORE_ALIAS_CERT_LEN));
	mock_expect_save_arg (&manager.x509_mock.mock, 0, 0);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.init_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL);
	status |= mock_expect_save_arg (&manager.x509_mock.mock, 0, 1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_root_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTSS_RSA_CA_NOPL_DER_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_intermediate_ca,
		&manager.x509_mock,	X509_ENGINE_INTER_CA_FAILED, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTCA_ECC_CA_NOPL_DER_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_certificate,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (0));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, X509_ENGINE_INTER_CA_FAILED, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_add_device_id_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_with_mock (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.load_certificate,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL,
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN),
		MOCK_ARG (RIOT_CORE_ALIAS_CERT_LEN));
	mock_expect_save_arg (&manager.x509_mock.mock, 0, 0);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.init_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL);
	status |= mock_expect_save_arg (&manager.x509_mock.mock, 0, 1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_root_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTSS_RSA_CA_NOPL_DER_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_intermediate_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTCA_ECC_CA_NOPL_DER_LEN));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_intermediate_ca,
		&manager.x509_mock,	X509_ENGINE_INTER_CA_FAILED, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_DEVID_INTR_SIGNED_CERT,
		RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), MOCK_ARG (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_certificate,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (0));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, X509_ENGINE_INTER_CA_FAILED, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_verify_stored_certs_authenticate_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_with_mock (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	int_der = platform_malloc (X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, int_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	memcpy (int_der, X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (2),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTCA_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTCA_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.load_certificate,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL,
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_ALIAS_CERT, RIOT_CORE_ALIAS_CERT_LEN),
		MOCK_ARG (RIOT_CORE_ALIAS_CERT_LEN));
	mock_expect_save_arg (&manager.x509_mock.mock, 0, 0);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.init_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_NOT_NULL);
	status |= mock_expect_save_arg (&manager.x509_mock.mock, 0, 1);

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_root_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTSS_RSA_CA_NOPL_DER_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_intermediate_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTCA_ECC_CA_NOPL_DER_LEN));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.add_intermediate_ca,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1),
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_DEVID_INTR_SIGNED_CERT,
		RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), MOCK_ARG (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.authenticate,
		&manager.x509_mock, X509_ENGINE_AUTH_FAILED, MOCK_ARG_SAVED_ARG (0),
		MOCK_ARG_SAVED_ARG (1));

	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_ca_cert_store,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (1));
	status |= mock_expect (&manager.x509_mock.mock, manager.x509_mock.base.release_certificate,
		&manager.x509_mock, 0, MOCK_ARG_SAVED_ARG (0));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, X509_ENGINE_AUTH_FAILED, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_store_signed_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.save_key, &manager.keystore,
		0, MOCK_ARG (0),
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN),
		MOCK_ARG (RIOT_CORE_DEVID_SIGNED_CERT_LEN));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_store_signed_device_id (&manager.test, RIOT_CORE_DEVID_SIGNED_CERT,
		RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_store_signed_device_id_auth_chain_stored (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;

	TEST_START;

	riot_key_manager_testing_init_auth_chain_stored (test, &manager);

	status = riot_key_manager_store_signed_device_id (&manager.test, RIOT_CORE_DEVID_SIGNED_CERT,
		RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_KEYSTORE_LOCKED, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_RSA_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_RSA_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) int_ca);

	status = testing_validate_array (X509_CERTCA_ECC_CA_NOPL_DER, int_ca->cert,
		X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTCA_ECC_CA_NOPL_DER_LEN, int_ca->length);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_INTR_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_store_signed_device_id_after_chain_verified (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_ECC_CA_NOPL_DER, X509_CERTSS_ECC_CA_NOPL_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, 0, status);

	status = mock_validate (&manager.keystore.mock);
	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_store_signed_device_id (&manager.test, RIOT_CORE_DEVID_SIGNED_CERT,
		RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_KEYSTORE_LOCKED, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_ECC_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_ECC_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_store_signed_device_id_null (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	status = riot_key_manager_store_signed_device_id (NULL, RIOT_CORE_DEVID_SIGNED_CERT,
		RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_store_signed_device_id (&manager.test, NULL,
		RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_store_signed_device_id (&manager.test, RIOT_CORE_DEVID_SIGNED_CERT,
		0);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_store_signed_device_id_save_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.save_key, &manager.keystore,
		KEYSTORE_SAVE_FAILED, MOCK_ARG (0),
		MOCK_ARG_PTR_CONTAINS (RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN),
		MOCK_ARG (RIOT_CORE_DEVID_SIGNED_CERT_LEN));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_store_signed_device_id (&manager.test, RIOT_CORE_DEVID_SIGNED_CERT,
		RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, KEYSTORE_SAVE_FAILED, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_store_root_ca (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_dependencies (test, &manager);
	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (1), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	status = mock_validate (&manager.keystore.mock);
	CuAssertIntEquals (test, 0, status);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.save_key, &manager.keystore,
		0, MOCK_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTSS_RSA_CA_NOPL_DER_LEN));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_store_root_ca (&manager.test, X509_CERTSS_RSA_CA_NOPL_DER,
		X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_store_root_ca_auth_chain_stored (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;

	TEST_START;

	riot_key_manager_testing_init_auth_chain_stored (test, &manager);

	status = riot_key_manager_store_root_ca (&manager.test, X509_CERTSS_RSA_CA_NOPL_DER,
		X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_KEYSTORE_LOCKED, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_RSA_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_RSA_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) int_ca);

	status = testing_validate_array (X509_CERTCA_ECC_CA_NOPL_DER, int_ca->cert,
		X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTCA_ECC_CA_NOPL_DER_LEN, int_ca->length);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_INTR_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_store_root_ca_after_chain_verified (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_ECC_CA_NOPL_DER, X509_CERTSS_ECC_CA_NOPL_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, 0, status);

	status = mock_validate (&manager.keystore.mock);
	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_store_root_ca (&manager.test, X509_CERTSS_RSA_CA_NOPL_DER,
		X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_KEYSTORE_LOCKED, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_ECC_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_ECC_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_store_root_ca_null (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	status = riot_key_manager_store_root_ca (NULL, X509_CERTSS_RSA_CA_NOPL_DER,
		X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_store_root_ca (&manager.test, NULL, X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_store_root_ca (&manager.test, X509_CERTSS_RSA_CA_NOPL_DER, 0);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_store_root_ca_save_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.save_key, &manager.keystore,
		KEYSTORE_SAVE_FAILED, MOCK_ARG (1),
		MOCK_ARG_PTR_CONTAINS (X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTSS_RSA_CA_NOPL_DER_LEN));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_store_root_ca (&manager.test, X509_CERTSS_RSA_CA_NOPL_DER,
		X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, KEYSTORE_SAVE_FAILED, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_store_intermediate_ca (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_init_dependencies (test, &manager);
	riot_key_manager_testing_alloc_riot_core_keys (test, &manager.keys);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_INTR_SIGNED_CERT, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_RSA_CA_NOPL_DER, X509_CERTSS_RSA_CA_NOPL_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_RSA_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_RSA_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_init (&manager.test, &manager.state, &manager.keystore.base,
		&manager.keys, &manager.x509.base, NULL, 0);
	CuAssertIntEquals (test, 0, status);

	status = mock_validate (&manager.keystore.mock);
	CuAssertIntEquals (test, 0, status);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.save_key, &manager.keystore,
		0, MOCK_ARG (2),
		MOCK_ARG_PTR_CONTAINS (X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTCA_ECC_CA_NOPL_DER_LEN));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_store_intermediate_ca (&manager.test, X509_CERTCA_ECC_CA_NOPL_DER,
		X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_store_intermediate_ca_auth_chain_stored (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;

	TEST_START;

	riot_key_manager_testing_init_auth_chain_stored (test, &manager);

	status = riot_key_manager_store_intermediate_ca (&manager.test, X509_CERTCA_ECC_CA_NOPL_DER,
		X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_KEYSTORE_LOCKED, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_RSA_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_RSA_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) int_ca);

	status = testing_validate_array (X509_CERTCA_ECC_CA_NOPL_DER, int_ca->cert,
		X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTCA_ECC_CA_NOPL_DER_LEN, int_ca->length);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_INTR_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_store_intermediate_ca_after_chain_verified (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_ECC_CA_NOPL_DER, X509_CERTSS_ECC_CA_NOPL_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, 0, status);

	status = mock_validate (&manager.keystore.mock);
	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_store_intermediate_ca (&manager.test, X509_CERTCA_ECC_CA_NOPL_DER,
		X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_KEYSTORE_LOCKED, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_ECC_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_ECC_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_store_intermediate_ca_null (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	status = riot_key_manager_store_intermediate_ca (NULL, X509_CERTCA_ECC_CA_NOPL_DER,
		X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_store_intermediate_ca (&manager.test, NULL,
		X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_store_intermediate_ca (&manager.test, X509_CERTCA_ECC_CA_NOPL_DER, 0);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_store_intermediate_ca_save_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.save_key, &manager.keystore,
		KEYSTORE_SAVE_FAILED, MOCK_ARG (2),
		MOCK_ARG_PTR_CONTAINS (X509_CERTCA_ECC_CA_NOPL_DER, X509_CERTCA_ECC_CA_NOPL_DER_LEN),
		MOCK_ARG (X509_CERTCA_ECC_CA_NOPL_DER_LEN));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_store_intermediate_ca (&manager.test, X509_CERTCA_ECC_CA_NOPL_DER,
		X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, KEYSTORE_SAVE_FAILED, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_release_riot_keys (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;
	uint8_t *dev_id_der = NULL;
	uint8_t *ca_der = NULL;
	uint8_t *int_der = NULL;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	dev_id_der = platform_malloc (RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertPtrNotNull (test, dev_id_der);

	ca_der = platform_malloc (X509_CERTSS_ECC_CA_NOPL_DER_LEN);
	CuAssertPtrNotNull (test, ca_der);

	memcpy (dev_id_der, RIOT_CORE_DEVID_SIGNED_CERT, RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	memcpy (ca_der, X509_CERTSS_ECC_CA_NOPL_DER, X509_CERTSS_ECC_CA_NOPL_DER_LEN);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.load_key, &manager.keystore,
		0, MOCK_ARG (0), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &dev_id_der, sizeof (dev_id_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &RIOT_CORE_DEVID_SIGNED_CERT_LEN,
		sizeof (RIOT_CORE_DEVID_SIGNED_CERT_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, 0, MOCK_ARG (1),	MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &ca_der, sizeof (ca_der), -1);
	status |= mock_expect_output (&manager.keystore.mock, 2, &X509_CERTSS_ECC_CA_NOPL_DER_LEN,
		sizeof (X509_CERTSS_ECC_CA_NOPL_DER_LEN), -1);

	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.load_key,
		&manager.keystore, KEYSTORE_NO_KEY,	MOCK_ARG (2), MOCK_ARG_NOT_NULL, MOCK_ARG_NOT_NULL);
	status |= mock_expect_output (&manager.keystore.mock, 1, &int_der, sizeof (int_der), -1);

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_verify_stored_certs (&manager.test);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_ECC_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_ECC_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_release_riot_keys_null (CuTest *test)
{
	struct riot_key_manager_testing manager;
	const struct riot_keys *dev_keys;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (NULL, dev_keys);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_erase_all_certificates (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;

	TEST_START;

	riot_key_manager_testing_init_auth_chain_stored (test, &manager);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.erase_key,
		&manager.keystore, 0, MOCK_ARG (0));
	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.erase_key,
		&manager.keystore, 0, MOCK_ARG (1));
	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.erase_key,
		&manager.keystore, 0, MOCK_ARG (2));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_erase_all_certificates (&manager.test);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) root_ca);

	status = testing_validate_array (X509_CERTSS_RSA_CA_NOPL_DER, root_ca->cert,
		X509_CERTSS_RSA_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTSS_RSA_CA_NOPL_DER_LEN, root_ca->length);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrNotNull (test, (struct der_cert*) int_ca);

	status = testing_validate_array (X509_CERTCA_ECC_CA_NOPL_DER, int_ca->cert,
		X509_CERTCA_ECC_CA_NOPL_DER_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CERTCA_ECC_CA_NOPL_DER_LEN, int_ca->length);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_INTR_SIGNED_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_INTR_SIGNED_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_erase_all_certificates_none_stored (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	const struct riot_keys *dev_keys;
	const struct der_cert *root_ca;
	const struct der_cert *int_ca;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.erase_key,
		&manager.keystore, 0, MOCK_ARG (0));
	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.erase_key,
		&manager.keystore, 0, MOCK_ARG (1));
	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.erase_key,
		&manager.keystore, 0, MOCK_ARG (2));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_erase_all_certificates (&manager.test);
	CuAssertIntEquals (test, 0, status);

	dev_keys = riot_key_manager_get_riot_keys (&manager.test);
	CuAssertTrue (test, (&manager.keys != dev_keys));

	riot_key_manager_release_riot_keys (&manager.test, dev_keys);

	root_ca = riot_key_manager_get_root_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) root_ca);

	int_ca = riot_key_manager_get_intermediate_ca (&manager.test);
	CuAssertPtrEquals (test, NULL, (struct der_cert*) int_ca);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, dev_keys->devid_csr,
		RIOT_CORE_DEVID_CSR_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, dev_keys->devid_csr_length);

	status = testing_validate_array (RIOT_CORE_DEVID_CERT, dev_keys->devid_cert,
		RIOT_CORE_DEVID_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CERT_LEN, dev_keys->devid_cert_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_KEY, dev_keys->alias_key,
		RIOT_CORE_ALIAS_KEY_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_KEY_LEN, dev_keys->alias_key_length);

	status = testing_validate_array (RIOT_CORE_ALIAS_CERT, dev_keys->alias_cert,
		RIOT_CORE_ALIAS_CERT_LEN);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_ALIAS_CERT_LEN, dev_keys->alias_cert_length);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_erase_all_certificates_null (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	status = riot_key_manager_erase_all_certificates (NULL);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_erase_all_certificates_device_id_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.erase_key,
		&manager.keystore, KEYSTORE_ERASE_FAILED, MOCK_ARG (0));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_erase_all_certificates (&manager.test);
	CuAssertIntEquals (test, KEYSTORE_ERASE_FAILED, status);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_erase_all_certificates_root_ca_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.erase_key,
		&manager.keystore, 0, MOCK_ARG (0));
	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.erase_key,
		&manager.keystore, KEYSTORE_ERASE_FAILED, MOCK_ARG (1));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_erase_all_certificates (&manager.test);
	CuAssertIntEquals (test, KEYSTORE_ERASE_FAILED, status);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_erase_all_certificates_intermediate_ca_error (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	status = mock_expect (&manager.keystore.mock, manager.keystore.base.erase_key,
		&manager.keystore, 0, MOCK_ARG (0));
	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.erase_key,
		&manager.keystore, 0, MOCK_ARG (1));
	status |= mock_expect (&manager.keystore.mock, manager.keystore.base.erase_key,
		&manager.keystore, KEYSTORE_ERASE_FAILED, MOCK_ARG (2));

	CuAssertIntEquals (test, 0, status);

	status = riot_key_manager_erase_all_certificates (&manager.test);
	CuAssertIntEquals (test, KEYSTORE_ERASE_FAILED, status);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_get_csr_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	struct der_cert csr;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	status = riot_key_manager_get_csr (&manager.test, 0, &csr);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, csr.length);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, csr.cert, csr.length);
	CuAssertIntEquals (test, 0, status);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_get_csr_index_1 (CuTest *test)
{
	struct riot_key_manager_testing manager;
	const struct der_cert extra_csr = {
		.cert = X509_CSR_ECC_CA_DER,
		.length = X509_CSR_ECC_CA_DER_LEN
	};
	int status;
	struct der_cert csr;

	TEST_START;

	riot_key_manager_testing_init_extra_csrs (test, &manager, &extra_csr, 1);

	status = riot_key_manager_get_csr (&manager.test, 1, &csr);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CSR_ECC_CA_DER_LEN, csr.length);

	status = testing_validate_array (X509_CSR_ECC_CA_DER, csr.cert, csr.length);
	CuAssertIntEquals (test, 0, status);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_get_csr_index_3 (CuTest *test)
{
	struct riot_key_manager_testing manager;
	const struct der_cert extra_csr[] = {
		{
			.cert = X509_CSR_ECC_CA_DER,
			.length = X509_CSR_ECC_CA_DER_LEN
		},
		{
			.cert = X509_CSR_ECC384_CA_DER,
			.length = X509_CSR_ECC384_CA_DER_LEN
		},
		{
			.cert = X509_CSR_ECC521_CA_DER,
			.length = X509_CSR_ECC521_CA_DER_LEN
		},
		{
			.cert = X509_CSR_ECC_CA_NOPL_DER,
			.length = X509_CSR_ECC384_SHA256_CA_DER_LEN
		}
	};
	int status;
	struct der_cert csr;

	TEST_START;

	riot_key_manager_testing_init_extra_csrs (test, &manager, extra_csr, ARRAY_SIZE (extra_csr));

	status = riot_key_manager_get_csr (&manager.test, 3, &csr);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CSR_ECC521_CA_DER_LEN, csr.length);

	status = testing_validate_array (X509_CSR_ECC521_CA_DER, csr.cert, csr.length);
	CuAssertIntEquals (test, 0, status);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_get_csr_static_keys_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	struct der_cert csr;

	TEST_START;

	riot_key_manager_testing_init_static_keys (test, &manager, NULL, 0);

	status = riot_key_manager_get_csr (&manager.test, 0, &csr);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, csr.length);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, csr.cert, csr.length);
	CuAssertIntEquals (test, 0, status);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_get_csr_static_keys_index_3 (CuTest *test)
{
	struct riot_key_manager_testing manager;
	const struct der_cert extra_csr[] = {
		{
			.cert = X509_CSR_ECC_CA_DER,
			.length = X509_CSR_ECC_CA_DER_LEN
		},
		{
			.cert = X509_CSR_ECC384_CA_DER,
			.length = X509_CSR_ECC384_CA_DER_LEN
		},
		{
			.cert = X509_CSR_ECC521_CA_DER,
			.length = X509_CSR_ECC521_CA_DER_LEN
		},
		{
			.cert = X509_CSR_ECC_CA_NOPL_DER,
			.length = X509_CSR_ECC384_SHA256_CA_DER_LEN
		}
	};
	int status;
	struct der_cert csr;

	TEST_START;

	riot_key_manager_testing_init_static_keys (test, &manager, extra_csr, ARRAY_SIZE (extra_csr));

	status = riot_key_manager_get_csr (&manager.test, 3, &csr);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CSR_ECC521_CA_DER_LEN, csr.length);

	status = testing_validate_array (X509_CSR_ECC521_CA_DER, csr.cert, csr.length);
	CuAssertIntEquals (test, 0, status);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_get_csr_static_init_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, NULL, 0)
	};
	int status;
	struct der_cert csr;

	TEST_START;

	riot_key_manager_testing_static_init (test, &manager);

	status = riot_key_manager_get_csr (&manager.test, 0, &csr);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, csr.length);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, csr.cert, csr.length);
	CuAssertIntEquals (test, 0, status);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_get_csr_static_init_index_3 (CuTest *test)
{
	const struct der_cert extra_csr[] = {
		{
			.cert = X509_CSR_ECC_CA_DER,
			.length = X509_CSR_ECC_CA_DER_LEN
		},
		{
			.cert = X509_CSR_ECC384_CA_DER,
			.length = X509_CSR_ECC384_CA_DER_LEN
		},
		{
			.cert = X509_CSR_ECC521_CA_DER,
			.length = X509_CSR_ECC521_CA_DER_LEN
		},
		{
			.cert = X509_CSR_ECC_CA_NOPL_DER,
			.length = X509_CSR_ECC384_SHA256_CA_DER_LEN
		}
	};
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, extra_csr, ARRAY_SIZE (extra_csr))
	};
	int status;
	struct der_cert csr;

	TEST_START;

	riot_key_manager_testing_static_init (test, &manager);

	status = riot_key_manager_get_csr (&manager.test, 3, &csr);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CSR_ECC521_CA_DER_LEN, csr.length);

	status = testing_validate_array (X509_CSR_ECC521_CA_DER, csr.cert, csr.length);
	CuAssertIntEquals (test, 0, status);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_get_csr_static_init_static_keys_device_id (CuTest *test)
{
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, NULL, 0)
	};
	int status;
	struct der_cert csr;

	TEST_START;

	riot_key_manager_testing_static_init_static_keys (test, &manager);

	status = riot_key_manager_get_csr (&manager.test, 0, &csr);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, RIOT_CORE_DEVID_CSR_LEN, csr.length);

	status = testing_validate_array (RIOT_CORE_DEVID_CSR, csr.cert, csr.length);
	CuAssertIntEquals (test, 0, status);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_get_csr_static_init_static_keys_index_3 (CuTest *test)
{
	const struct der_cert extra_csr[] = {
		{
			.cert = X509_CSR_ECC_CA_DER,
			.length = X509_CSR_ECC_CA_DER_LEN
		},
		{
			.cert = X509_CSR_ECC384_CA_DER,
			.length = X509_CSR_ECC384_CA_DER_LEN
		},
		{
			.cert = X509_CSR_ECC521_CA_DER,
			.length = X509_CSR_ECC521_CA_DER_LEN
		},
		{
			.cert = X509_CSR_ECC_CA_NOPL_DER,
			.length = X509_CSR_ECC384_SHA256_CA_DER_LEN
		}
	};
	struct riot_key_manager_testing manager = {
		.test = riot_key_manager_static_init (&manager.state, &manager.keystore.base,
			&manager.x509.base, extra_csr, ARRAY_SIZE (extra_csr))
	};
	int status;
	struct der_cert csr;

	TEST_START;

	riot_key_manager_testing_static_init_static_keys (test, &manager);

	status = riot_key_manager_get_csr (&manager.test, 3, &csr);
	CuAssertIntEquals (test, 0, status);
	CuAssertIntEquals (test, X509_CSR_ECC521_CA_DER_LEN, csr.length);

	status = testing_validate_array (X509_CSR_ECC521_CA_DER, csr.cert, csr.length);
	CuAssertIntEquals (test, 0, status);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_get_csr_null (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	struct der_cert csr;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	status = riot_key_manager_get_csr (NULL, 0, &csr);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	status = riot_key_manager_get_csr (&manager.test, 0, NULL);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_INVALID_ARGUMENT, status);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_get_csr_index_1_no_extra_csrs (CuTest *test)
{
	struct riot_key_manager_testing manager;
	int status;
	struct der_cert csr;

	TEST_START;

	riot_key_manager_testing_init (test, &manager);

	status = riot_key_manager_get_csr (&manager.test, 1, &csr);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_UNKNOWN_CSR, status);

	riot_key_manager_testing_release (test, &manager);
}

static void riot_key_manager_test_get_csr_out_of_range (CuTest *test)
{
	struct riot_key_manager_testing manager;
	const struct der_cert extra_csr[] = {
		{
			.cert = X509_CSR_ECC_CA_DER,
			.length = X509_CSR_ECC_CA_DER_LEN
		},
		{
			.cert = X509_CSR_ECC384_CA_DER,
			.length = X509_CSR_ECC384_CA_DER_LEN
		},
		{
			.cert = X509_CSR_ECC521_CA_DER,
			.length = X509_CSR_ECC521_CA_DER_LEN
		},
		{
			.cert = X509_CSR_ECC_CA_NOPL_DER,
			.length = X509_CSR_ECC384_SHA256_CA_DER_LEN
		}
	};
	int status;
	struct der_cert csr;

	TEST_START;

	riot_key_manager_testing_init_extra_csrs (test, &manager, extra_csr, ARRAY_SIZE (extra_csr));

	status = riot_key_manager_get_csr (&manager.test, 5, &csr);
	CuAssertIntEquals (test, RIOT_KEY_MANAGER_UNKNOWN_CSR, status);

	riot_key_manager_testing_release (test, &manager);
}


// *INDENT-OFF*
TEST_SUITE_START (riot_key_manager);

TEST (riot_key_manager_test_init_no_signed_device_id);
TEST (riot_key_manager_test_init_bad_signed_device_id);
TEST (riot_key_manager_test_init_signed_device_id);
TEST (riot_key_manager_test_init_intermediate_signed_device_id);
TEST (riot_key_manager_test_init_signed_device_id_no_root_ca);
TEST (riot_key_manager_test_init_signed_device_id_bad_root_ca);
TEST (riot_key_manager_test_init_signed_device_id_not_signed_by_root);
TEST (riot_key_manager_test_init_signed_device_id_not_sign_alias_cert);
TEST (riot_key_manager_test_init_intermediate_signed_device_id_no_ca);
TEST (riot_key_manager_test_init_intermediate_signed_device_id_bad_ca);
TEST (riot_key_manager_test_init_intermediate_signed_device_id_not_trusted);
TEST (riot_key_manager_test_init_authentication_mock);
TEST (riot_key_manager_test_init_extra_csr);
TEST (riot_key_manager_test_init_null);
TEST (riot_key_manager_test_init_signed_device_id_load_error);
TEST (riot_key_manager_test_init_root_ca_load_error);
TEST (riot_key_manager_test_init_intermediate_ca_load_error);
TEST (riot_key_manager_test_init_authenticate_load_alias_error);
TEST (riot_key_manager_test_init_authenticate_init_cert_store_error);
TEST (riot_key_manager_test_init_authenticate_add_root_ca_error);
TEST (riot_key_manager_test_init_authenticate_add_intermediate_ca_error);
TEST (riot_key_manager_test_init_authenticate_add_device_id_error);
TEST (riot_key_manager_test_init_authenticate_error);
TEST (riot_key_manager_test_init_static_keys_no_signed_device_id);
TEST (riot_key_manager_test_init_static_keys_bad_signed_device_id);
TEST (riot_key_manager_test_init_static_keys_signed_device_id);
TEST (riot_key_manager_test_init_static_keys_extra_csr);
TEST (riot_key_manager_test_init_static_keys_null);
TEST (riot_key_manager_test_static_init_no_signed_device_id);
TEST (riot_key_manager_test_static_init_bad_signed_device_id);
TEST (riot_key_manager_test_static_init_signed_device_id);
TEST (riot_key_manager_test_static_init_intermediate_signed_device_id);
TEST (riot_key_manager_test_static_init_signed_device_id_no_root_ca);
TEST (riot_key_manager_test_static_init_signed_device_id_bad_root_ca);
TEST (riot_key_manager_test_static_init_signed_device_id_not_signed_by_root);
TEST (riot_key_manager_test_static_init_signed_device_id_not_sign_alias_cert);
TEST (riot_key_manager_test_static_init_intermediate_signed_device_id_no_ca);
TEST (riot_key_manager_test_static_init_intermediate_signed_device_id_bad_ca);
TEST (riot_key_manager_test_static_init_intermediate_signed_device_id_not_trusted);
TEST (riot_key_manager_test_static_init_authentication_mock);
TEST (riot_key_manager_test_static_init_extra_csr);
TEST (riot_key_manager_test_static_init_null);
TEST (riot_key_manager_test_static_init_signed_device_id_load_error);
TEST (riot_key_manager_test_static_init_root_ca_load_error);
TEST (riot_key_manager_test_static_init_intermediate_ca_load_error);
TEST (riot_key_manager_test_static_init_authenticate_load_alias_error);
TEST (riot_key_manager_test_static_init_authenticate_init_cert_store_error);
TEST (riot_key_manager_test_static_init_authenticate_add_root_ca_error);
TEST (riot_key_manager_test_static_init_authenticate_add_intermediate_ca_error);
TEST (riot_key_manager_test_static_init_authenticate_add_device_id_error);
TEST (riot_key_manager_test_static_init_authenticate_error);
TEST (riot_key_manager_test_static_init_static_keys_no_signed_device_id);
TEST (riot_key_manager_test_static_init_static_keys_bad_signed_device_id);
TEST (riot_key_manager_test_static_init_static_keys_signed_device_id);
TEST (riot_key_manager_test_static_init_static_keys_extra_csr);
TEST (riot_key_manager_test_static_init_static_keys_null);
TEST (riot_key_manager_test_release_null);
TEST (riot_key_manager_test_get_riot_keys_null);
TEST (riot_key_manager_test_get_root_ca_null);
TEST (riot_key_manager_test_get_intermediate_ca_null);
TEST (riot_key_manager_test_verify_stored_certs_no_signed_device_id);
TEST (riot_key_manager_test_verify_stored_certs_bad_signed_device_id);
TEST (riot_key_manager_test_verify_stored_certs_signed_device_id);
TEST (riot_key_manager_test_verify_stored_certs_intermediate_signed_device_id);
TEST (riot_key_manager_test_verify_stored_certs_signed_device_id_no_root_ca);
TEST (riot_key_manager_test_verify_stored_certs_signed_device_id_bad_root_ca);
TEST (riot_key_manager_test_verify_stored_certs_signed_device_id_not_signed_by_root);
TEST (riot_key_manager_test_verify_stored_certs_signed_device_id_not_sign_alias_cert);
TEST (riot_key_manager_test_verify_stored_certs_intermediate_signed_device_id_no_ca);
TEST (riot_key_manager_test_verify_stored_certs_intermediate_signed_device_id_bad_ca);
TEST (riot_key_manager_test_verify_stored_certs_intermediate_signed_device_id_not_trusted);
TEST (riot_key_manager_test_verify_stored_certs_static_keys);
TEST (riot_key_manager_test_verify_stored_certs_static_init);
TEST (riot_key_manager_test_verify_stored_certs_static_init_static_keys);
TEST (riot_key_manager_test_verify_stored_certs_null);
TEST (riot_key_manager_test_verify_stored_certs_signed_device_id_load_error);
TEST (riot_key_manager_test_verify_stored_certs_root_ca_load_error);
TEST (riot_key_manager_test_verify_stored_certs_intermediate_ca_load_error);
TEST (riot_key_manager_test_verify_stored_certs_load_alias_error);
TEST (riot_key_manager_test_verify_stored_certs_init_cert_store_error);
TEST (riot_key_manager_test_verify_stored_certs_add_root_ca_error);
TEST (riot_key_manager_test_verify_stored_certs_add_intermediate_ca_error);
TEST (riot_key_manager_test_verify_stored_certs_add_device_id_error);
TEST (riot_key_manager_test_verify_stored_certs_authenticate_error);
TEST (riot_key_manager_test_store_signed_device_id);
TEST (riot_key_manager_test_store_signed_device_id_auth_chain_stored);
TEST (riot_key_manager_test_store_signed_device_id_after_chain_verified);
TEST (riot_key_manager_test_store_signed_device_id_null);
TEST (riot_key_manager_test_store_signed_device_id_save_error);
TEST (riot_key_manager_test_store_root_ca);
TEST (riot_key_manager_test_store_root_ca_auth_chain_stored);
TEST (riot_key_manager_test_store_root_ca_after_chain_verified);
TEST (riot_key_manager_test_store_root_ca_null);
TEST (riot_key_manager_test_store_root_ca_save_error);
TEST (riot_key_manager_test_store_intermediate_ca);
TEST (riot_key_manager_test_store_intermediate_ca_auth_chain_stored);
TEST (riot_key_manager_test_store_intermediate_ca_after_chain_verified);
TEST (riot_key_manager_test_store_intermediate_ca_null);
TEST (riot_key_manager_test_store_intermediate_ca_save_error);
TEST (riot_key_manager_test_release_riot_keys);
TEST (riot_key_manager_test_release_riot_keys_null);
TEST (riot_key_manager_test_erase_all_certificates);
TEST (riot_key_manager_test_erase_all_certificates_none_stored);
TEST (riot_key_manager_test_erase_all_certificates_null);
TEST (riot_key_manager_test_erase_all_certificates_device_id_error);
TEST (riot_key_manager_test_erase_all_certificates_root_ca_error);
TEST (riot_key_manager_test_erase_all_certificates_intermediate_ca_error);
TEST (riot_key_manager_test_get_csr_device_id);
TEST (riot_key_manager_test_get_csr_index_1);
TEST (riot_key_manager_test_get_csr_index_3);
TEST (riot_key_manager_test_get_csr_static_keys_device_id);
TEST (riot_key_manager_test_get_csr_static_keys_index_3);
TEST (riot_key_manager_test_get_csr_static_init_device_id);
TEST (riot_key_manager_test_get_csr_static_init_index_3);
TEST (riot_key_manager_test_get_csr_static_init_static_keys_device_id);
TEST (riot_key_manager_test_get_csr_static_init_static_keys_index_3);
TEST (riot_key_manager_test_get_csr_null);
TEST (riot_key_manager_test_get_csr_index_1_no_extra_csrs);
TEST (riot_key_manager_test_get_csr_out_of_range);

TEST_SUITE_END;
// *INDENT-ON*
